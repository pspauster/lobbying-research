---
title: "Real Estate Lobbying Spending"
author: "Patrick Spauster"
date: '2024-01-21'
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(googlesheets4)
library(janitor)
library(RPublica) #https://www.r-project.org/nosvn/pandoc/RPublica.html
library(curl)
library(httr)
library(jsonlite)
library(RSocrata)
library(DT)



knitr::opts_chunk$set(echo = FALSE, warning = FALSE)

options(scipen = 999)
```

# Organizations Investigated

-   Real Estate Board of New York, Inc
-   Homeowners for an Affordable New York LLC
-   Taxpayers for an Affordable NY LLC
-   Community Housing Improvement Program (CHIP)
-   Rent Stabilization Association of NYC, INC
-   NYS Association of Realtors

```{r, include=FALSE}
beneficial_client_names <- c('TAXPAYERS FOR AN AFFORDABLE NY, INC.;' , 'Homeowners for an Affordable New York LLC;' , 'REAL ESTATE BOARD OF NEW YORK, INC.;' , 'COMMUNITY HOUSING IMPROVEMENT PROGRAM, INC.;' , 'RENT STABILIZATION ASSOCIATION OF NYC, INC.;', 'ASSOCIATION OF REALTORS (NYS);')

principal_lobbyist_names <- c('TAXPAYERS FOR AN AFFORDABLE NY, INC.','Homeowners for an Affordable New York LLC','REAL ESTATE BOARD OF NEW YORK, INC.','COMMUNITY HOUSING IMPROVEMENT PROGRAM, INC.' , 'RENT STABILIZATION ASSOCIATION OF NYC, INC.', "ASSOCIATION OF REALTORS (NYS)")

```

There are three different types of data available from the state lobbying records.

1.  Compensation for lobbyists
2.  Expenses and spending by lobbyists
3.  Lobbying activities and targets

```{r include=F}
combined <- read_csv(URLencode(
  "https://data.ny.gov/resource/t9kf-dqbc.csv?$where=beneficial_client_name = 'TAXPAYERS FOR AN AFFORDABLE NY, INC.;' OR beneficial_client_name = 'Homeowners for an Affordable New York LLC;' OR beneficial_client_name = 'REAL ESTATE BOARD OF NEW YORK, INC.;' OR beneficial_client_name = 'COMMUNITY HOUSING IMPROVEMENT PROGRAM, INC.;' OR beneficial_client_name = 'RENT STABILIZATION ASSOCIATION OF NYC, INC.;' OR principal_lobbyist_name = 'TAXPAYERS FOR AN AFFORDABLE NY, INC.' OR principal_lobbyist_name = 'Homeowners for an Affordable New York LLC' OR principal_lobbyist_name='REAL ESTATE BOARD OF NEW YORK, INC.' OR principal_lobbyist_name = 'COMMUNITY HOUSING IMPROVEMENT PROGRAM, INC.' OR principal_lobbyist_name = 'RENT STABILIZATION ASSOCIATION OF NYC, INC.' &$LIMIT= 100000"))

compensation <- combined %>% 
  select(form_submission_id:compensation, unique_id) %>% 
  group_by(form_submission_id) %>% 
  summarize_all(first)

expenses <- combined %>% 
  select(form_submission_id, reporting_year, beneficial_client_name, reimbursed_expenses:coalition_contribution_expense, unique_id) %>% 
  mutate(expense_id = map_chr(str_split(unique_id, "-"), 3))

itemized_expenses <- filter(expenses, expense_id != "0") %>% 
  group_by(expense_id) %>% 
  summarize_all(first)

other_expenses <- filter(expenses, expense_id == "0")

lobbying_activities <- combined %>% 
  select(form_submission_id, reporting_year, beneficial_client_name, lobbying_subjects:unique_id)
```

# 1.    Compensation

## Total Compensation spending by all parties since 2019

```{r}
compensation %>% 
  group_by(reporting_year) %>% 
  summarize(total_compensation = sum(compensation)) %>% 
  ggplot()+
  geom_line(mapping = aes(x = reporting_year, y = total_compensation))
```

## Lobbying compensation over time by organization
```{r}
compensation %>% 
  group_by(reporting_year, beneficial_client_name) %>% 
  summarize(total_compensation = sum(compensation)) %>% 
  arrange(beneficial_client_name) %>% 
  pivot_wider(names_from = reporting_year, values_from = total_compensation) %>% 
  adorn_totals(where = c("row", "col")) %>% 
  datatable()
  
```

## Top Lobbying groups by Amount Compensated

```{r}
compensation %>% 
  mutate(principal_lobbyist_name = if_else(principal_lobbyist_name == "99 SOLUTIONS, LLC", "99 SOLUTIONS LLC.", principal_lobbyist_name)) %>% 
  group_by(principal_lobbyist_name) %>% 
  summarize(total_compensation = sum(compensation)) %>% 
  arrange(desc(total_compensation)) %>% 
  adorn_totals() %>% 
  datatable()

```

## Top Lobbyists by Amount Compensated

```{r}
#if time come back and parse the names by splitting column and then standardizing case

compensation %>% 
  group_by(individual_lobbyist_name) %>% 
  summarize(total_compensation = sum(compensation)) %>% 
  arrange(desc(total_compensation)) %>% 
  adorn_totals() %>% 
  datatable()

```

# 2.    Expenses

## Total itemized expenses by year
```{r}

itemized_expenses %>% 
  group_by(reporting_year, beneficial_client_name) %>% 
  summarize(total_expenses = sum(itemized_expenses)) %>% 
  arrange(beneficial_client_name) %>% 
  pivot_wider(names_from = reporting_year, values_from = total_expenses) %>% 
  adorn_totals(where = c("row", "col")) %>% 
  datatable()

```

## Types of expenses and their frequency

```{r}

itemized_expenses %>% 
  group_by(expense_purpose) %>% 
  summarize(
    number_of_expenses = n(),
    total_expenses = sum(itemized_expenses)
    ) %>% 
  arrange(desc(total_expenses)) %>% 
  adorn_totals() %>% 
  datatable()

```
# Types of expenses and their frequency broken out by larger category
```{r}
itemized_expenses %>% 
  separate(expense_purpose, sep = " – ", into = c("expense_category", "expense_category_detail")) %>% 
  mutate(expense_category = case_when(
    is.na(expense_category) ~ "Unknown",
    str_detect(expense_category, "Consulting")~"Consulting",
    T ~ expense_category
  )) %>% 
  group_by(expense_category) %>% 
  summarize(
    number_of_expenses = n(),
    total_expenses = sum(itemized_expenses)
    ) %>% 
  arrange(desc(total_expenses)) %>% 
  adorn_totals() %>% 
  datatable()
```
```{r}
itemized_expenses %>% 
  separate(expense_purpose, sep = " – ", into = c("expense_category", "expense_category_detail")) %>% 
  mutate(expense_category = case_when(
    is.na(expense_category) ~ "Unknown",
    str_detect(expense_category, "Consulting")~"Consulting",
    T ~ expense_category
  )) %>% 
  group_by(expense_category) %>% 
  summarize(
    number_of_expenses = n(),
    values = sum(itemized_expenses),
    ) %>% 
  ggplot()+
  geom_col(mapping = aes(x = "", y = values, fill = expense_category))+
  theme_minimal()+
  scale_y_continuous(labels = scales::comma_format())+
  labs(title = "How Real Estate Spent Money",
       x = "",
       y = "$"
       )

```



# 3.    Targets of Lobbying

## Most targeted Issues

```{r}
lobbying_activities %>% group_by(lobbying_subjects) %>% summarize(contacts= n()) %>% arrange(desc(contacts)) %>% datatable()
```

## Most Targeted Laws

```{r}

lobbying_activities %>%
  mutate(bill = case_when(
    focus_identifying_number == "A4740-A" ~ "Green Roof Tax Abatement",
    focus_identifying_number == "S5554-A" ~ "Green Roof Tax Abatement",
    focus_identifying_number == "A9006-A" ~ "Education, Labor, Housing and family assistance budget",
    focus_identifying_number == "S3082" ~ "Good Cause",
    focus_identifying_number == "A5573" ~ "Good Cause",
    focus_identifying_number == 'A4454' ~ "Good Cause",
    focus_identifying_number == "S8006-A" ~ "Education, Labor, Housing and family assistance budget",
    focus_identifying_number == "S2892" ~"Good Cause",
    focus_identifying_number == "A3006" ~ "Education, Labor, Housing and family assistance budget",
    focus_identifying_number == "A2008C" ~ "Transportation, economic development, environmental conservation budget",
    focus_identifying_number == "S1508" ~ "Transportation, economic development, environmental conservation budget",
    focus_identifying_number == "A2008" ~ "Transportation, economic development, environmental conservation budget",
    focus_identifying_number == "S1947" ~ "Hours, Wages, and supplements in contracts for public work",
    focus_identifying_number == "A1261" ~ "Hours, Wages, and supplements in contracts for public work",
    focus_identifying_number == "A1915" ~ "Prevailing wage in large city developments",
    focus_identifying_number == "S305" ~ "Good Cause",
    focus_identifying_number == 'Intended introduction regarding good cause eviction' ~ "Good Cause",
    T ~ focus_identifying_number
  )) %>% 
  group_by(bill) %>%
  summarize(contacts= n()) %>% arrange(desc(contacts))%>%
  adorn_totals() %>% 
  filter(bill == "Total" | row_number() <= 10) %>% 
  datatable()

```

## Most targeted people

```{r}
lobbying_activities %>%
  mutate(
         party_name_clean = case_when(
    str_detect(party_name,"Kavanagh")~"Brian Kavanagh",
    str_detect(party_name,"Heastie")~"Carl Heastie",
    str_detect(party_name,"Skoufis")~"James Skoufis",
    str_detect(party_name,"Cymbrowitz") ~ "Steven Cymbrowitz",
    str_detect(party_name,"Mannion") ~ "John Mannion",
    str_detect(party_name,"Adams") ~ "Eric Adams",
    str_detect(party_name,"Johnson") ~ "Corey Johnson",
    str_detect(party_name,"Kaplan") ~ "Anna Kaplan",
    str_detect(party_name,"Kaminsky") ~ "Todd Kaminsky",
    str_detect(party_name,"Stewart-Cousins") ~ "Andrea Stewart-Cousins",
    str_detect(party_name,"Comrie") ~ "Leroy Comrie",
    str_detect(party_name,"Hochul") ~ "Kathy Hochul", #double check this one
    str_detect(party_name,"Executive Chamber") ~ "Executive Chamber",
    
    party_name == "New York State Senate" ~ "General",
    party_name =="New York Assembly" ~ "General",
    party_name =="NYC Council Central Staff" ~ "General",
    party_name =="Homes and Community Renewal (HCR)" ~ "General",
    party_name =="NYC Department of City Planning (DCP)" ~ "General",
    
    T ~ str_remove_all(party_name, "Senator |Assemblymember |Assembly member ")
  )) %>% 
  group_by(party_name_clean) %>%
  summarize(contacts= n()) %>% arrange(desc(contacts))%>%
  #head(10) %>% 
  datatable()


```

# Focus: Good Cause

## In periods where Real Estate Lobbied against good cause, they compensated lobbyists

```{r}
good_cause_codes <- c('S305','Intended introduction regarding good cause eviction', 'S3082', 'A5573', 'S2892', 'A4454')

gc_filings <- combined %>% filter(focus_identifying_number %in% good_cause_codes) %>%  pull(form_submission_id)
```

```{r}
compensation %>% 
  filter(form_submission_id %in% gc_filings) %>% 
  group_by(beneficial_client_name) %>% 
  summarize(total_compensation = sum(compensation)) %>% 
  arrange(beneficial_client_name) %>% 
  adorn_totals() %>% 
  datatable()


```
## In periods where Real Estate Lobbied against good cause, they spent this much on expenses

```{r}
itemized_expenses %>%
  filter(form_submission_id %in% gc_filings) %>% 
  group_by(expense_purpose) %>% 
  summarize(
    number_of_expenses = n(),
    total_expenses = sum(itemized_expenses)
    ) %>% 
  arrange(desc(total_expenses)) %>% 
  adorn_totals() %>% 
  datatable()


```
## Types of expenses and their frequency broken out by larger category
```{r}
itemized_expenses %>% 
  filter(form_submission_id %in% gc_filings) %>% 
  separate(expense_purpose, sep = " – ", into = c("expense_category", "expense_category_detail")) %>% 
  group_by(expense_category) %>% 
  summarize(
    number_of_expenses = n(),
    total_expenses = sum(itemized_expenses)
    ) %>% 
  arrange(desc(total_expenses)) %>% 
  adorn_totals() %>% 
  datatable()
```
## They targeted the following people most often when lobbying around good cause

```{r}

lobbying_activities %>% 
  filter(focus_identifying_number %in% good_cause_codes) %>% 
  group_by(party_name) %>%
  summarize(contacts= n()) %>% arrange(desc(contacts))%>%
  #head(10) %>% 
  datatable()

```
# Browse all the data

## Compensation
```{r}

compensation %>% datatable()

```

## Expenses
```{r}
itemized_expenses %>% datatable()
```

## Lobbying contacts
```{r}
lobbying_activities %>% datatable()
```

